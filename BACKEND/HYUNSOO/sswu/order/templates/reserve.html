{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/reserve.css' %}" />

    <title>굿즈 예약</title>
  </head>
  <body>
    <!-- 상단바 -->
    <div class="top_bar">
      <a href="https://">
        <img
          src="{% static 'img/backicon.svg' %}"
          alt="백버튼"
          class="back_btn"
      /></a>
      <a href="https://">
        <img src="{% static 'img/prismPink.svg' %}" alt="로고" class="logo_img"
      /></a>
      <a href="https://">
        <img
          src="{% static 'img/hamburger.svg' %}"
          alt="햄버거 버튼"
          class="ham_btn"
      /></a>
    </div>

    <form
      method="post"
      action="{% url 'order:reserve' %}"
      onsubmit="showReservation();"
    >
      {% csrf_token %}

      <!-- 굿즈 예약 설명 -->
      <div class="booking">
        <div class="top">
          <img
            src="{% static 'img/staricon.svg' %}"
            alt="반짝이"
            class="sparkle"
          />
          <span class="booking_text">굿즈 예약</span>
        </div>
      </div>
      <div class="insert">
        <div class="text">성함</div>
        <input
          type="text"
          placeholder="성함을 입력해주세요."
          class="text_input"
          name="user_name"
          required
        />
      </div>
      <div class="insert">
        <div class="text">연락처</div>
        <input
          type="text"
          placeholder="하이픈(-) 없이 작성해주세요."
          class="text_input"
          name="phone_number"
          required
        />
      </div>
      <div class="insert">
        <div class="text">이메일</div>
        <input
          type="text"
          placeholder="ex) mutsa@gmail.com"
          class="text_input"
          name="user_mail"
          required
        />
      </div>

      <!-- {{ form.purchase_date.label_tag }} {{ form.purchase_date }}<br /> -->
      <!-- 원하는 구매 일자 -->
      <div class="insert">
        <div class="text">원하는 구매 일자</div>
        <div class="select_date">
            {% for choice_value, choice_label in form.purchase_date.field.choices %}
            <label>
                <input 
                type="radio" 
                name="{{ form.purchase_date.name }}" 
                value="{{ choice_value }}" 
                style="opacity: 0; position: absolute; z-index: -1;" 
                id="radio_{{ forloop.counter }}"
                {% if forloop.first %}required{% endif %} />
                <img
                src="{% static 'img/checkboxNull.svg' %}"
                alt="체크 안 됨"
                id="check_icon{{ forloop.counter }}"
                class="check_icon"
                onclick="toggleImage('check_icon{{ forloop.counter }}', 'radio_{{ forloop.counter }}')" />
                <span class="date">{{ choice_label }}</span>
            </label>
            {% endfor %}
        </div>
      </div>
    
      <div class="insert">
          <div class="text">구매 시간</div>
          <select class="num_select" name="purchase_time" required>
              <option value="" disabled selected>시간 선택</option>
              {% for time_value, time_label in form.purchase_time.field.choices %}
              <option value="{{ time_value }}">{{ time_label }}</option>
              {% endfor %}
          </select>
      </div>    
      <hr />

      <!--선택한 상품 및 총액 확인 부분-->
      <!-- <h3>선택한 상품</h3> -->
      {% for good_name, good_info in request.session.selected_goods.items %}
      <!--세션을 통해서 선택한 굿즈 정보를 가져옴-->

      <!-- 예약 목록 -->
      <div class="list">
        <div class="select_item">
            <span class="item">{{ good_name }} - {{ good_info.quantity }}개</span>
            <span class="price">{{ good_info.price|multiply:good_info.quantity }}₩</span>
        </div>
      </div>
      {% endfor %}
      <h3>총액: {{ total_price }} 원</h3>

      <!-- <div>
        <h4>{{ good_name }}</h4>
        <p>가격: {{ good_info.price }} 원</p>
        <p>수량: {{ good_info.quantity }}</p>
      </div>
      <h3>총액: {{ total_price }} 원</h3> -->

      <!-- 예약 버튼 -->
      <!-- 예약 버튼 -->
      <a href="https://">
        <div class="btn">
          <button type="submit" class="booking_btn">예약하기</button>
        </div></a
      >

      <!-- <button type="submit">예약 완료</button> -->
      {% if form.errors %}{{ form.errors }}{% endif %}
    </form>
    <div id="popup">
      <h2>예약완료!</h2>
      <div id="popup-content"></div>
      <button onclick="Home()">홈으로이동</button>
      <button onclick="showGoodsList()">굿즈목록보기</button>
    </div>

    <script>
      function showReservation() {
        const userName = document.querySelector("[name='user_name']").value;

        let goodInfo = "";
        const goodsElements = document.querySelectorAll("h4, p");
        goodsElements.forEach((el) => {
          goodInfo += el.innerText + "\n";
        });

        const purchaseData = document.querySelector(
          "[name ='purchase_data']"
        ).value;
        const purchaseTime = document.querySelector(
          "[name ='purchase_time']"
        ).value;
        const totalPrice = "{{ total_price }}";

        const message =
          "예약이 완료되었습니다. \n\n" +
          userName +
          "님의 굿즈 구매 예약이 완료되었습니다!\n 해당 시간에 총학 부스에 와서 결제 후 수령해주세요." +
          goodInfo +
          "\n" +
          "예약시간: " +
          purchaseTime +
          "총 금액: " +
          totalPrice +
          "원";

        alert(message);
      }

      //   날짜 선택
      let isChecked1 = false; // 10월 4일 이미지 상태
      let isChecked2 = false; // 10월 5일 이미지 상태

      function toggleImage(iconId, radioId) {
        const icon = document.getElementById(iconId);
        const radio = document.getElementById(radioId);
    
        if (!radio.checked) {
            // 모든 아이콘을 초기 상태로 설정합니다.
            document.querySelectorAll('.check_icon').forEach((iconElem) => {
                iconElem.setAttribute("src", "{% static 'img/checkboxNull.svg' %}");
            });
            // 선택한 아이콘만 체크 상태로 변경합니다.
            icon.setAttribute("src", "{% static 'img/checkbox.svg' %}");
            radio.checked = true;
        }
      }    
    </script>
  </body>
</html>