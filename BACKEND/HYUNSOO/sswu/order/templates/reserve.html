<!DOCTYPE html>
<html>
<head>
    <title>굿즈 예약</title>
    <style>
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid black;
            z-index: 999;
        }
    </style>
</head>
<body>
    <form method="post" action="{% url 'order:reserve' %}" onsubmit="showReservation(event);">
        {% csrf_token %}
        
        <!--사용자 정보 입력 부분-->
        {{ form.user_name.label_tag }} {{ form.user_name }}<br>
        {{ form.phone_number.label_tag }} {{ form.phone_number }}<br>
        {{ form.user_mail.label_tag }} {{ form.user_mail }}<br>
        {{ form.purchase_date.label_tag }} {{ form.purchase_date }}<br>
        {{ form.purchase_time.label_tag }} {{ form.purchase_time }}<br>

        <!--선택한 상품 및 총액 확인 부분-->
        <h3>선택한 상품</h3>
        {% for good_name, good_info in request.session.selected_goods.items %} <!--세션을 통해서 선택한 굿즈 정보를 가져옴-->
        <div>
            <h4>{{ good_name }}</h4>
            <p>가격: {{ good_info.price }} 원</p>
            <p>수량: {{ good_info.quantity }}</p>
        </div>
        {% endfor %}
        <h3>총액: {{ total_price }} 원</h3>

        <button type="submit">예약 완료</button>
        {% if form.errors %}{{ form.errors }}{% endif %}
    </form>
    <div id="popup">
        <h2>예약완료!</h2>
        <div id="popup-content"></div>
        <button onclick="Home()">홈으로이동</button>
        <button onclick="showGoodsList()">굿즈목록보기</button>
    </div>
    <script>
        function showReservation(event) {
            event.preventDefault();
    
            const formData = new FormData(event.target);

            fetch("{% url 'order:reserve' %}", {
                method: "POST",
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const userName = document.querySelector("[name='user_name']").value;
                    let goodInfo = "";
                    const goodsElements = document.querySelectorAll("h4, p");
                    goodsElements.forEach(el => {
                        goodInfo += el.innerText + "\n";
                    });

                    const purchaseDate = document.querySelector("[name='purchase_date']").value;
                    const purchaseTime = document.querySelector("[name ='purchase_time']").value;
                    const totalPrice = "{{ total_price }}";

                    const message = 
                        "예약이 완료되었습니다. \n\n"+
                        userName + "님의 굿즈 구매 예약이 완료되었습니다!\n 해당 시간에 총학 부스에 와서 결제 후 수령해주세요.\n"+
                        goodInfo+ "\n"+
                        "예약시간: " + purchaseTime +
                        "총 금액: " + totalPrice + "원";

                    const popupContent = document.getElementById("popup-content");
                    popupContent.innerText = message;

                    document.getElementById('popup').style.display = 'block';
                } else {
                    alert("예약 중 오류가 발생했습니다. 다시 시도해주세요.");
                }
            });
        }
        function Home() {
            window.location.href = "{% url 'order:home' %}";
        }

        function showGoodsList() {
            window.location.href = "{% url 'order:goods_list' %}";
        }

    </script>
</body>
</html>
